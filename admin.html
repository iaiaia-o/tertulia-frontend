<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administración - Tertulias Literarias</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-shadow {
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50">

<!-- Login Screen -->
<div id="login-screen" class="min-h-screen flex items-center justify-center gradient-bg">
    <div class="bg-white rounded-lg card-shadow p-8 w-full max-w-md">
        <div class="text-center mb-8">
            <div class="w-16 h-16 bg-purple-600 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-shield-alt text-white text-2xl"></i>
            </div>
            <h1 class="text-2xl font-bold text-gray-800">Panel de Administración</h1>
            <p class="text-gray-600 mt-2">Acceso restringido para administradores</p>
        </div>

        <form id="login-form" class="space-y-6">
            <div id="login-message" class="hidden p-3 rounded-lg"></div>
            
            <div>
                <label for="password" class="block text-sm font-semibold text-gray-700 mb-2">
                    <i class="fas fa-lock mr-2"></i>Contraseña
                </label>
                <input type="password" id="password" name="password" required
                       placeholder="Ingresa la contraseña de administrador"
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
            </div>

            <button type="submit" id="login-btn"
                    class="w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-lg transition-all duration-300">
                <span id="login-text">
                    <i class="fas fa-sign-in-alt mr-2"></i>Iniciar Sesión
                </span>
                <span id="login-loading" class="hidden">
                    <div class="loading-spinner inline-block mr-2"></div>Verificando...
                </span>
            </button>
        </form>

        <div class="mt-6 text-center">
            <a href="index.html" class="text-purple-600 hover:text-purple-700 text-sm">
                <i class="fas fa-arrow-left mr-2"></i>Volver al sitio público
            </a>
        </div>
    </div>
</div>

<!-- Admin Dashboard -->
<div id="admin-dashboard" class="hidden min-h-screen bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center">
                    <div class="w-10 h-10 bg-purple-600 rounded-lg flex items-center justify-center mr-3">
                        <i class="fas fa-shield-alt text-white"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-gray-900">Panel de Administración</h1>
                        <p class="text-sm text-gray-600">Gestión de Tertulias Literarias</p>
                    </div>
                </div>
                <div class="flex items-center space-x-3">
                    <button id="refresh-btn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors">
                        <i class="fas fa-sync-alt mr-2"></i>Actualizar
                    </button>
                    <button id="logout-btn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-colors">
                        <i class="fas fa-sign-out-alt mr-2"></i>Cerrar Sesión
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Estadísticas Generales -->
        <div class="mb-8">
            <h2 class="text-2xl font-bold text-gray-900 mb-6">Estadísticas Generales</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="bg-white rounded-lg card-shadow p-6">
                    <div class="flex items-center">
                        <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center mr-4">
                            <i class="fas fa-users text-blue-600 text-xl"></i>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-600">Total Inscripciones</p>
                            <p id="total-inscriptions" class="text-2xl font-bold text-gray-900">0</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg card-shadow p-6">
                    <div class="flex items-center">
                        <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center mr-4">
                            <i class="fas fa-check-circle text-green-600 text-xl"></i>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-600">Confirmadas</p>
                            <p id="confirmed-inscriptions" class="text-2xl font-bold text-gray-900">0</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg card-shadow p-6">
                    <div class="flex items-center">
                        <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center mr-4">
                            <i class="fas fa-book text-purple-600 text-xl"></i>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-600">Total Tertulias</p>
                            <p id="total-tertulias" class="text-2xl font-bold text-gray-900">0</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg card-shadow p-6">
                    <div class="flex items-center">
                        <div class="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center mr-4">
                            <i class="fas fa-chair text-orange-600 text-xl"></i>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-600">Plazas Disponibles</p>
                            <p id="available-spots" class="text-2xl font-bold text-gray-900">0</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Crear Nueva Tertulia -->
        <div class="mb-8">
            <div class="bg-white rounded-lg card-shadow p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-gray-900">
                        <i class="fas fa-plus-circle mr-2 text-green-600"></i>Gestión de Tertulias
                    </h2>
                    <button id="toggle-create-form" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors">
                        <i class="fas fa-plus mr-2"></i>Nueva Tertulia
                    </button>
                </div>

                <!-- Formulario de crear tertulia -->
                <div id="create-tertulia-form" class="hidden mb-6">
                    <form id="new-tertulia-form" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="tertulia-title" class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-heading mr-2"></i>Título de la Tertulia
                            </label>
                            <input type="text" id="tertulia-title" name="title" required
                                   placeholder="Ej: Tertulia de Novela Histórica"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        </div>

                        <div>
                            <label for="tertulia-date" class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-calendar mr-2"></i>Fecha y Hora
                            </label>
                            <input type="datetime-local" id="tertulia-date" name="date" required
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        </div>

                        <div class="md:col-span-2">
                            <label for="tertulia-description" class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-align-left mr-2"></i>Descripción
                            </label>
                            <textarea id="tertulia-description" name="description" rows="3" required
                                      placeholder="Describe el tema, libro o enfoque de esta tertulia..."
                                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"></textarea>
                        </div>

                        <div>
                            <label for="tertulia-max-participants" class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-users mr-2"></i>Máximo de Participantes
                            </label>
                            <input type="number" id="tertulia-max-participants" name="max_participants" 
                                   value="12" min="1" max="50" required
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        </div>

                        <div>
                            <label for="tertulia-location" class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-map-marker-alt mr-2"></i>Ubicación (Opcional)
                            </label>
                            <input type="text" id="tertulia-location" name="location"
                                   placeholder="Ej: Biblioteca Central, Sala 3"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        </div>

                        <div class="md:col-span-2 flex justify-end space-x-3">
                            <button type="button" id="cancel-create" class="px-6 py-3 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
                                <i class="fas fa-times mr-2"></i>Cancelar
                            </button>
                            <button type="submit" id="create-tertulia-btn" class="bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg transition-colors">
                                <span id="create-text">
                                    <i class="fas fa-plus mr-2"></i>Crear Tertulia
                                </span>
                                <span id="create-loading" class="hidden">
                                    <div class="loading-spinner inline-block mr-2"></div>Creando...
                                </span>
                            </button>
                        </div>
                    </form>

                    <div id="create-message" class="hidden mt-4 p-3 rounded-lg"></div>
                </div>

                <!-- Lista de tertulias existentes -->
                <div id="tertulias-list">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">
                        <i class="fas fa-list mr-2"></i>Tertulias Programadas
                    </h3>
                    <div id="tertulias-container" class="space-y-4">
                        <!-- Las tertulias se cargarán aquí -->
                    </div>
                    <div id="no-tertulias" class="text-center py-8">
                        <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-book text-gray-400 text-2xl"></i>
                        </div>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">No hay tertulias programadas</h3>
                        <p class="text-gray-600">Crea una nueva tertulia para comenzar</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Inscripciones -->
        <div class="bg-white rounded-lg card-shadow p-6">
            <h2 class="text-xl font-bold text-gray-900 mb-6">
                <i class="fas fa-list mr-2 text-blue-600"></i>Inscripciones
                <span class="text-sm font-normal text-gray-600">Gestiona el estado de las inscripciones</span>
            </h2>

            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Participante</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tertulia</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="inscriptions-tbody" class="bg-white divide-y divide-gray-200">
                        <!-- Las inscripciones se cargarán aquí dinámicamente -->
                    </tbody>
                </table>

                <div id="no-inscriptions" class="text-center py-12">
                    <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-inbox text-gray-400 text-2xl"></i>
                    </div>
                    <h3 class="text-lg font-medium text-gray-900 mb-2">No hay inscripciones que mostrar</h3>
                    <p class="text-gray-600">Las inscripciones aparecerán aquí cuando los usuarios se registren</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Configuración de la API
const API_BASE = 'https://nghki1cjlmw6.manus.space/api';

// Estado de autenticación
let isLoggedIn = false;

// Elementos del DOM
const loginScreen = document.getElementById('login-screen');
const adminDashboard = document.getElementById('admin-dashboard');
const loginForm = document.getElementById('login-form');
const loginMessage = document.getElementById('login-message');
const loginBtn = document.getElementById('login-btn');
const loginText = document.getElementById('login-text');
const loginLoading = document.getElementById('login-loading');

// Elementos del formulario de crear tertulia
const toggleCreateForm = document.getElementById('toggle-create-form');
const createTertuliaForm = document.getElementById('create-tertulia-form');
const newTertuliaForm = document.getElementById('new-tertulia-form');
const cancelCreate = document.getElementById('cancel-create');
const createMessage = document.getElementById('create-message');
const createTertuliaBtn = document.getElementById('create-tertulia-btn');
const createText = document.getElementById('create-text');
const createLoading = document.getElementById('create-loading');

// Función de login
loginForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const password = document.getElementById('password').value;
    
    // Mostrar loading
    loginText.classList.add('hidden');
    loginLoading.classList.remove('hidden');
    loginBtn.disabled = true;
    
    // Simular verificación (en un caso real, esto sería una llamada al servidor)
    setTimeout(() => {
        if (password === 'admin123') {
            isLoggedIn = true;
            loginScreen.classList.add('hidden');
            adminDashboard.classList.remove('hidden');
            loadDashboardData();
        } else {
            showLoginMessage('Contraseña incorrecta. Inténtalo de nuevo.', 'error');
        }
        
        // Ocultar loading
        loginText.classList.remove('hidden');
        loginLoading.classList.add('hidden');
        loginBtn.disabled = false;
    }, 1000);
});

// Función para mostrar mensajes de login
function showLoginMessage(message, type) {
    loginMessage.textContent = message;
    loginMessage.className = 'p-3 rounded-lg ' + (type === 'error' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700');
    loginMessage.classList.remove('hidden');
    
    setTimeout(() => {
        loginMessage.classList.add('hidden');
    }, 5000);
}

// Función para mostrar mensajes de creación
function showCreateMessage(message, type) {
    createMessage.textContent = message;
    createMessage.className = 'p-3 rounded-lg ' + (type === 'error' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700');
    createMessage.classList.remove('hidden');
    
    setTimeout(() => {
        createMessage.classList.add('hidden');
    }, 5000);
}

// Toggle del formulario de crear tertulia
toggleCreateForm.addEventListener('click', function() {
    createTertuliaForm.classList.toggle('hidden');
    if (!createTertuliaForm.classList.contains('hidden')) {
        // Establecer fecha mínima como hoy
        const now = new Date();
        const minDate = now.toISOString().slice(0, 16);
        document.getElementById('tertulia-date').min = minDate;
    }
});

// Cancelar creación
cancelCreate.addEventListener('click', function() {
    createTertuliaForm.classList.add('hidden');
    newTertuliaForm.reset();
    createMessage.classList.add('hidden');
});

// Crear nueva tertulia
newTertuliaForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    // Mostrar loading
    createText.classList.add('hidden');
    createLoading.classList.remove('hidden');
    createTertuliaBtn.disabled = true;
    
    const formData = new FormData(newTertuliaForm);
    const tertuliaData = {
        title: formData.get('title'),
        description: formData.get('description'),
        date: formData.get('date'),
        max_participants: parseInt(formData.get('max_participants')),
        location: formData.get('location') || null
    };
    
    try {
        const response = await fetch(API_BASE + '/tertulias', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(tertuliaData)
        });
        
        if (response.ok) {
            showCreateMessage('¡Tertulia creada exitosamente!', 'success');
            newTertuliaForm.reset();
            createTertuliaForm.classList.add('hidden');
            loadDashboardData(); // Recargar datos
        } else {
            throw new Error('Error al crear la tertulia');
        }
    } catch (error) {
        console.error('Error:', error);
        showCreateMessage('Error al crear la tertulia. Inténtalo de nuevo.', 'error');
    } finally {
        // Ocultar loading
        createText.classList.remove('hidden');
        createLoading.classList.add('hidden');
        createTertuliaBtn.disabled = false;
    }
});

// Función para eliminar tertulia
async function deleteTertulia(id) {
    if (!confirm('¿Estás seguro de que quieres eliminar esta tertulia?')) {
        return;
    }
    
    try {
        const response = await fetch(API_BASE + '/tertulias/' + id, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            showCreateMessage('Tertulia eliminada exitosamente', 'success');
            loadDashboardData();
        } else {
            throw new Error('Error al eliminar la tertulia');
        }
    } catch (error) {
        console.error('Error:', error);
        showCreateMessage('Error al eliminar la tertulia', 'error');
    }
}

// Función para cargar datos del dashboard
async function loadDashboardData() {
    try {
        // Cargar estadísticas
        const inscriptionsResponse = await fetch(API_BASE + '/inscriptions');
        const tertuliasResponse = await fetch(API_BASE + '/tertulias');
        
        const inscriptions = await inscriptionsResponse.json();
        const tertulias = await tertuliasResponse.json();
        
        // Actualizar estadísticas
        document.getElementById('total-inscriptions').textContent = inscriptions.length;
        document.getElementById('confirmed-inscriptions').textContent = 
            inscriptions.filter(i => i.status === 'confirmed').length;
        document.getElementById('total-tertulias').textContent = tertulias.length;
        
        // Calcular plazas disponibles
        const totalSpots = tertulias.reduce((sum, t) => sum + (t.max_participants || 12), 0);
        const usedSpots = inscriptions.filter(i => i.status === 'confirmed').length;
        document.getElementById('available-spots').textContent = totalSpots - usedSpots;
        
        // Cargar tertulias
        loadTertulias(tertulias);
        
        // Cargar inscripciones
        loadInscriptions(inscriptions);
        
    } catch (error) {
        console.error('Error loading dashboard data:', error);
    }
}

// Función para cargar tertulias
function loadTertulias(tertulias) {
    const container = document.getElementById('tertulias-container');
    const noTertulias = document.getElementById('no-tertulias');
    
    if (tertulias.length === 0) {
        container.innerHTML = '';
        noTertulias.classList.remove('hidden');
        return;
    }
    
    noTertulias.classList.add('hidden');
    container.innerHTML = tertulias.map(tertulia => {
        const date = new Date(tertulia.date).toLocaleString('es-ES');
        return `<div class="border border-gray-200 rounded-lg p-4 bg-gray-50">
            <div class="flex justify-between items-start">
                <div class="flex-1">
                    <h4 class="font-semibold text-gray-900">${tertulia.title}</h4>
                    <p class="text-sm text-gray-600 mt-1">${tertulia.description}</p>
                    <div class="flex items-center mt-2 text-sm text-gray-500">
                        <i class="fas fa-calendar mr-2"></i>
                        <span>${date}</span>
                        <i class="fas fa-users ml-4 mr-2"></i>
                        <span>Máx. ${tertulia.max_participants} participantes</span>
                        ${tertulia.location ? `<i class="fas fa-map-marker-alt ml-4 mr-2"></i><span>${tertulia.location}</span>` : ''}
                    </div>
                </div>
                <button onclick="deleteTertulia(${tertulia.id})" class="ml-4 text-red-600 hover:text-red-800">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>`;
    }).join('');
}

// Función para cargar inscripciones
function loadInscriptions(inscriptions) {
    const tbody = document.getElementById('inscriptions-tbody');
    const noInscriptions = document.getElementById('no-inscriptions');
    
    if (inscriptions.length === 0) {
        tbody.innerHTML = '';
        noInscriptions.classList.remove('hidden');
        return;
    }
    
    noInscriptions.classList.add('hidden');
    tbody.innerHTML = inscriptions.map(inscription => {
        const date = new Date(inscription.created_at).toLocaleDateString('es-ES');
        const statusClass = inscription.status === 'confirmed' ? 'bg-green-100 text-green-800' :
                           inscription.status === 'rejected' ? 'bg-red-100 text-red-800' :
                           'bg-yellow-100 text-yellow-800';
        const statusText = inscription.status === 'confirmed' ? 'Confirmada' :
                          inscription.status === 'rejected' ? 'Rechazada' :
                          'Pendiente';
        
        return `<tr class="hover:bg-gray-50">
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm font-medium text-gray-900">${inscription.name}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm text-gray-900">${inscription.email}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm text-gray-900">${inscription.tertulia_title || 'Tertulia Mensual'}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm text-gray-900">${date}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">
                    ${statusText}
                </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                <button onclick="updateInscriptionStatus(${inscription.id}, 'confirmed')" class="text-green-600 hover:text-green-900 mr-2">
                    <i class="fas fa-check"></i>
                </button>
                <button onclick="updateInscriptionStatus(${inscription.id}, 'rejected')" class="text-red-600 hover:text-red-900">
                    <i class="fas fa-times"></i>
                </button>
            </td>
        </tr>`;
    }).join('');
}

// Función para actualizar estado de inscripción
async function updateInscriptionStatus(id, status) {
    try {
        const response = await fetch(API_BASE + '/inscriptions/' + id, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ status: status })
        });
        
        if (response.ok) {
            loadDashboardData(); // Recargar datos
        } else {
            throw new Error('Error al actualizar el estado');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error al actualizar el estado de la inscripción');
    }
}

// Función de logout
document.getElementById('logout-btn').addEventListener('click', function() {
    isLoggedIn = false;
    loginScreen.classList.remove('hidden');
    adminDashboard.classList.add('hidden');
    document.getElementById('password').value = '';
    createTertuliaForm.classList.add('hidden');
    newTertuliaForm.reset();
});

// Función de actualizar
document.getElementById('refresh-btn').addEventListener('click', async function() {
    const btn = this;
    const icon = btn.querySelector('i');
    
    icon.classList.add('fa-spin');
    btn.disabled = true;
    
    try {
        await loadDashboardData();
    } finally {
        icon.classList.remove('fa-spin');
        btn.disabled = false;
    }
});

// Cargar datos iniciales si ya está logueado
if (isLoggedIn) {
    loadDashboardData();
}
</script>

</body>
</html>

